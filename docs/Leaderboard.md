# Kokomi 玩家排行榜 (Beta) 说明

## Bot 指令

**1. 查询指定服务器或者全服排行榜前 50 名数据**

- `wws [服务器/global] top [船名]`

> _eg. wws global top 信浓 / wws asia top 信浓_

---

**2. 查询自己船只在当前服务器或者全服排名**

- `wws me top [船名]`

- `wws me global top [船名]`

> _eg. wws me global top 哈兰_

---

**3. 查询别人船只排名**

- 指令同上，将 `me` 参数替换为 `服务器+ID` 的形式

> _eg. wws asia kokomi top 大和_

---

**4. 更新当前绑定账号的排行榜缓存数据**

- `wws update`

---

**5. 更新他人的缓存数据**

- 指令同上，但是在后面接 `服务器+ID`

> _eg. wws update asia kokomi_

---

## 排行榜功能说明

### 一、上榜要求

1. 船只等级在 6-11 级之间，且有服务器数据，所以没有低级船只和测试船只的数据
2. 用户必须在一年内有活跃数据，如果超过一段时间不活跃则**会被下榜处理**
3. 用户船只**在数据库中缓存数据**的场次需要达到一定要求(具体如下表)

   | 等级  | 场次 |
   | ----- | ---- |
   | 6-8   | 40   |
   | 9     | 50   |
   | 10-11 | 60   |

> 注意: 由于数据库用户数量巨大 (大概几百万)，数据不会那么即使更新，如果达到场次没有上榜，或者榜上数据是旧数据，可以手动使用 `update` 指令刷新自己的缓存数据

```txt
💡 重要的事情说三遍！！！

如果达到场次没有上榜，或者榜上数据是旧数据，可以手动使用 `update` 指令刷新自己的缓存数据
如果达到场次没有上榜，或者榜上数据是旧数据，可以手动使用 `update` 指令刷新自己的缓存数据
如果达到场次没有上榜，或者榜上数据是旧数据，可以手动使用 `update` 指令刷新自己的缓存数据
```

## 二、排行榜说明

排行榜的数据模式主要分为两种，一种是单个服务器的排名，另一种是全服排名。其中全服排名包括国服和俄服在内的所有个游戏服务器。

排行榜的刷新时间大致为每 30 - 60 分钟从数据库缓存数据中读取并刷新所有船只的排行榜，故更新用户缓存并不会直接更新排行榜数据，而是存在一个 10 - 30 分钟的延迟。

## 三、评分说明

排行榜上用户评分由以下公式计算得出:

    最终评分 = 原始评分 + 服务器修正 + 组队修正

### 1. 原始评分

原始评分的计算需要两样数据：用户数据和非加权平均的服务器数据

> 非加权平均的服务器数据指该船只在所有 5 个服务器数据的非加权平均值，数据来自 kokomi 平台的统计

此部分的代码如下

```python
# 用户数据
battles_count = user_data[0]
actual_wins = user_data[1] / battles_count * 100
actual_dmg = user_data[2] / battles_count
actual_frags = user_data[3] / battles_count
# 服务器数据
expected_wins = server_data[0]*100
expected_dmg = server_data[1]
expected_frags = server_data[2]
# 计算PR
# Step 1 - ratios:
r_wins = actual_wins / expected_wins
r_dmg = actual_dmg / expected_dmg
r_frags = actual_frags / expected_frags
# Step 2 - normalization:
n_wins = max(0, (r_wins - 0.7) / (1 - 0.7))
n_dmg = max(0, (r_dmg - 0.4) / (1 - 0.4))
n_frags = max(0, (r_frags - 0.1) / (1 - 0.1))
# Step 3 - PR value:
personal_rating = 700 * n_dmg + 300 * n_frags + 150 * n_wins
```

当前计算出的数据只是单纯的根据用户的数值高低来计算评分，但我们都知道，在不同服务器的环境下，不同船只的服务器平均数据是不一样的。例如对于同一艘船只 马克斯 在国服和欧服的数据差异能达到几万。所以对于此问题，我们在评分中引入的 `服务器修正` 的概念。

### 2. 服务器修正

> 注意：此处仅对计算全服排行榜时才有实际效果，对于单个服务器榜单内的用户比较来说，并无实际意义

对于此问题，我们可以举一个简化的例子：

```txt
假设有一艘船只 A ，他的数据如下：
    总体：9.5w
    亚服：10w
    国服：11w
    欧服：9w
    ......
```

```txt
首先我们按照总体的平均数据计算出第一步的原始评分，例如 2450 分

然后根据用户的所在的服务器，例如欧服用户。计算出该用户所在服务器的数据和总体服务器数据的差异并根据算法计算出修正值，例如欧服数据低于总体平均值，则服务器修正则就为一个正值。反之，国服就是为负值。

其中用户的评分越高，服务器数据和总体数据差距越高，服务器修正的绝对值也就越高。此处通常会有几百点PR的修正
```

### 3. 组队修正

通常来说，组三排进行打榜的效率通常情况下是远高于单野打榜的，极端的情况就例如 安娜玻璃丝 和 杰克逊维尔 ，可以达到极其离谱的胜率和场均。

所以我在设计排行榜的时候，就引入了 `组队修正` 的概念，通过计算单野，双排，三排的场次及其占比，来实现对于单野打榜的用户更加公平。

此处目前暂定的做法是，通过计算用户的单野占比和用户的胜率，对用户评分中的胜率组分进行修正。所以此处只会对胜率高且单野占比高的用户有较大的影响。

> 注意，目前此处的算法可会在后面进一步修改或者调整
